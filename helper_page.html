<!DOCTYPE html>
<html>
    <link rel="shortcut icon" type="image/x-icon" href="helpnow_favicon.ico"/>
    <title>HelpNow - Get Help</title>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
    <script src="https://code.jquery.com/jquery.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script>
    <script src="https://use.fontawesome.com/2a8a6780db.js"></script>
    <script src="https://cdn.jsdelivr.net/momentjs/2.12.0/moment.min.js"></script>

    <style type="text/css">
        body{
            background-color:#032642;
        }

        .jumbotron{
            background-color:#032642;
            min-height:130px;
            overflow: auto;
            padding:10px;
            margin-top:10px;
            margin-bottom:10px;
            display:flex;
        }
        ul{
            list-style:none;
            float:left;
            color:white;
        }
        ul>li{
            color:white;
        }

        img{
            height:100px;
            margin-right:15px;
        }

        #signOut,#RsignOut{
            text-decoration:underline;
            font-size:14px;
        }

        #signOut:hover,#RsignOut:hover{
            text-decoration:underline;
            font-size:16px;
            color:#77BDD9;
            font-weight:bold;
        }
        
        #Menu{
            margin:auto;
        }

        #Menu>#pageTitle,#Menu>#getHelp{
            background-color:#003600;
            border-radius:3px;
            border:3px solid white;
            color:white;
            padding:3px;
            font-size:16px;
            width:max-content;
            transition:font-size 1s ease;
            margin:auto;
        }

        #Menu>#getHelp{
            background-color:#991E37;
            margin-top:5px;
        }

        #Menu>#pageTitle:hover,#Menu>#getHelp:hover{
            font-size:19px;
        }

/*************************************GPS MODAL***********************************************/

        #correctAddress,#submit,#accept,#reject,#instruct{
            display:none;
        }

        #returnedAddress{
            font-weight:bold;
            font-size:20px;
            color:blue;
        }

        #accept{
            background-color:#003600;
            color:white;
            font-size:30px;
            font-weight:bold;
        }

        #reject{
            background-color:#991E37;
            color:white;
            font-size:30px;
            font-weight:bold;
        }

        #userInfo{
            color:white;
        }

        #correctAddress{
            width:100%;
        }

        #submit{
            border:3px solid #454545;
            color:#454545;
            font-size:30px;
            font-weight:bold;
        }

        input{
            font-size:20px;
        }

        #animateArrow{
            font-size:30px;
            animation-name:test;
            animation-iteration-count:infinite;
            animation-duration:1s;
        }

        @keyframes test{
              0%{
                font-size:30px;
              }
              50%{
                font-size:33px;
              }
              100%{
                font-size:30px;
              }
        } 

        /*********************************Map stuff*******************************************/
        #map{
            height:400px;
        }

        #Proceed{
            display:none;
        }       

        #request{
            color:red;
            font-weight:bold;
            font-style:italic;
        }

        .contact{
            width:100%;
            background-color:#003600;
            border-radius:10px;
            color:white;
            border:none;
            outline:none;
            font-size:20px;
        }

        .confirmMessage{
            border-radius:15px;
            color:#454545;
            background-color:#E5E5DB;
            border:5px solid #454545;
            font-size:40px;
            font-weight:bold;
        }

        .confirmMessage>p{
            display:inline;
            margin:10px;
        }

        #confirmModalBody{
            padding:0;
            border-radius:-5px;
        }

        #confirmBtn{
            font-size:30px;
            background-color:#454545;
            color:#E5E5DB
        }

/*************************MARKER LEGEND**********************/
        #markerInfo{
            margin-top:3px;
            margin-bottom:3px;
            display:inline-block;
            background-color:#403F3D;
            border:3px solid white;
            padding:5px;
            transition:all 1s ease-in-out;
        }

        #markerInfo:hover{
            transform:scale(1.1);
        }

        #markerInfo>div{
            display:inline-block;
        }
        #markerInfo>div>img{
            height:30px;
            display:inline;
        }

        #markerInfo>div>p{
            height:30px;
            display:inline;
            color:white;
        }

/*********************DISCLAIMER NOTE AT BOTTOM OF SHEET***************/
        #disclaimer{
            font-style:italic;
            font-size:16px;
            color:white;
        }

        #disclaimer>a{
            color:white;
        }

        #disclaimer>a:hover{
            font-size:18px;
            font-weight:bold;
            background-color:#991E37;
            border:3px solid white;
            border-radius:5px;
            padding:3px;
        }

        #requestModal>.modal-dialog{
            width:90%;
        }

        #requestModal>.modal-dialog>.modal-content{
            width:100%;
            margin:5% auto;
        }

        #Rmodal{
            background-color:#032642;
        }

        #userInfo_Rmodal > ul{
            text-align:left;
        }

        #actions{
          width:100%;
          height:100%;
          font-size:30px;
          border-radius:15px;
          padding:10px;
        }

        .collapsed{
          width:100%;
          display:none;
          height:0px;
          opacity:0;
          font-size:0px;
          text-align:center;
          border-radius:15px;
          border:3px solid white;
        }

        .animation-show{
          animation-duration:.1s;
          animation-name:expand;
          animation-fill-mode:forwards;
        }
        
        @keyframes expand{
          0%{
            opacity:0;
            height:0%;
            font-size:0px;
            display:none;
            border:0px solid white;
          }
          100%{
            opacity:1;
            height:100%;
            font-size:30px;
            display:block;
            padding:10px;
            border:3px solid white;
          }
        }
        
        .animation-hide{
          animation-duration:.1s;
          animation-name:collapse;
          animation-fill-mode:forwards;
        }
        
        @keyframes collapse{
          0%{
            opacity:1;
            height:100%;
            font-size:30px;
            display:block;
            padding:10px;
            border:2px solid white;
          }
          100%{
            opacity:0;
            height:0%;
            font-size:0px;
            display:none;
            border:0px solid white;
          }
        }

        #navigation,#complete,#contact{
            color:white;
        }

        #contact{
            background-color:#402E24;
        }

        #complete{
            background-color:#086268;
        }

        #navigation{
            background-color:#333333;
            width:100%;
            font-size:30px;
        }

        #contactDiv{
            background-color:#505853;
            color:white;
            width:100%;
            display:none;
            height:0px;
            opacity:0;
            font-size:0px;
            display:flex;
        }
        
        #navDiv{
            display:block;
            width:100%;
            color:white;
            background-color:#333333;
        }

        .contact-animation-show{
          animation-duration:.1s;
          animation-name:contactExpand;
          animation-fill-mode:forwards;
        }
        
        @keyframes contactExpand{
          0%{
            opacity:0;
            height:0%;
            font-size:0px;
            display:none;
            border:0px solid white;
          }
          100%{
            opacity:1;
            height:100%;
            font-size:30px;
            display:block;
            padding:10px;
            border:3px solid white;
          }
        }
        
        .contact-animation-hide{
          animation-duration:.1s;
          animation-name:contactCollapse;
          animation-fill-mode:forwards;
        }
        
        @keyframes contactCollapse{
          0%{
            opacity:1;
            height:100%;
            font-size:30px;
            display:block;
            padding:10px;
            border:2px solid white;
          }
          100%{
            opacity:0;
            height:0%;
            font-size:0px;
            display:none;
            border:0px solid white;
          }
        }

        #offerMsg{
            color:white;
            font-size:20px;
        }

        #routeDiv>p,#routeDiv{
            font-size:15px;
            text-align:left;
        }

        #Rmodal>.modal-body{
            overflow: auto;
        }
    
    </style>

<body>

    <div class="jumbotron">
        
        <div id = "userInfo"></div>
    
        <div id="Menu" class="text-center">
            <p id='pageTitle'>You are on Go Help Page</p>
            <p id='getHelp'>Click here to go to Get Help Page</p>
        </div>

        <img src="HelpNow Logo.png">

    </div>

    <div id="map">
        
    </div>

    <div id="markerLegend" class="text-center">
        <div id="markerInfo">
            <div class="text-center"><p>current location:</p><img src="http://maps.google.com/mapfiles/ms/icons/green-dot.png"></div>
            <div class="text-center"><p>open help requests:</p><img src="http://maps.google.com/mapfiles/ms/icons/red-dot.png"></div>
        </div>
    </div>

    <p id="disclaimer">Disclaimer: Please note that, if you have an open request, your request has been filtered out from your view. Only people that can help you will see your request. If you have an outstanding request, and would like to manage it, <a href="#">click here to go to GET HELP page</a></p>

    <div id="gpsModal" class="modal fade" tabindex="-1" role="dialog" aria-labelledby="myModalLabel">
        <div class="modal-dialog" role="document">
            <div class="modal-content">

                <div class="modal-body text-center" id="gps-body">
        
                    <div id="address"></div><!--will display message with calculated address-->
                    
                    <button class="btn btn-default btn-block" id="accept">
                        <i class="fa fa-check"></i><i class="fa fa-fw"></i>Accept
                    </button>

                    <button class="btn btn-default btn-block" id="reject">
                        <i class="fa fa-times"></i><i class="fa fa-fw"></i>Reject
                    </button>

                    <button id="reject">Reject</button>

                    <div id="instruct">Please enter your correct address. Provided is your currently stored address, if set.</div>
                    <input class="text-center" type="text" id="correctAddress" placeholder="1234 Simpleton Dr, Dallas TX 75204">
                    <button id="submit" class="btn btn-default btn-block">
                        Submit<i class="fa fa-fw"></i><i class="fa fa-arrow-right" id="animateArrow"></i>
                    </button>

                </div>

                <div class="modal-footer text-center">

                    <button class = "btn btn-primary btn-block" type="button" data-dismiss="modal" aria-hidden="true" id ="Proceed">Continue to Site</button>

                </div>

            </div>
        </div>
    </div>

    <div id="confirmModal" class="modal fade" tabindex="-1" role="dialog" aria-labelledby="myModalLabel">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-body" id="confirmModalBody">
                    <div class="confirmMessage text-center"></div>
                </div>
            </div>
        </div>
    </div>

    <div id="helperModal" class="modal fade" tabindex="-1" role="dialog" aria-labelledby="myModalLabel">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-body" id="confirmModalBody">
                    <div class="confirmMessage text-center"></div>
                </div>
            </div>
        </div>
    </div>

    <div id="requestModal" class="modal fade" tabindex="-1" role="dialog" aria-labelledby="myModalLabel">
        <div class="modal-dialog" role="document">
            <div id = "Rmodal" class="modal-content">

                <div class="modal-body text-center">

                    <div id="jumbotron_Rmodal" class="jumbotron">
                        
                        <div id = "userInfo_Rmodal"></div>
                        <div id="Menu" class="text-center">
                            <p id='pageTitle'>You are on Go Help Page</p>
                            <p id='getHelp'>Click here to go to Get Help Page</p>
                        </div>                    
                        <img id="logo_Rmodal" src="HelpNow Logo.png">

                    </div>

                     <div id="pendingRequest"></div>

                </div>
            </div>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/4.3.1/firebase.js"></script>
    <script type="text/javascript">

    //////////////////////////////////////////////firebase code/////////////////////////////////////////////////

        var config = {
            apiKey: "AIzaSyBzJ9AknkEz3TmAHLEryoXaT74nLSf9mQQ",
            authDomain: "project1-ad91c.firebaseapp.com",
            databaseURL: "https://project1-ad91c.firebaseio.com",
            projectId: "project1-ad91c",
            storageBucket: "project1-ad91c.appspot.com",
            messagingSenderId: "297815876711"
        };
        firebase.initializeApp(config);

        var dB = firebase.database();
        var Auth = firebase.auth();
        var cloud = firebase.storage();
        var provider_fb = new firebase.auth.FacebookAuthProvider();
        var provider_goog = new firebase.auth.GoogleAuthProvider();
        var userLoggedIn=false;
        var myReftoDisconnect;
        var myLocationRef;

        var userObj;//will be user object with all kinds of datas
        var databaseObj,modalShown = false;
        //get instance of real-time database
        dB.ref().on("value",function(snapshot){
            databaseObj = snapshot.toJSON();//setting databaseObj to the entire firebase onvalue change snapshot gives me the current firebase with every change that occurs to the firebase
            //firebase function to check whether user is logged into site
            Auth.onAuthStateChanged(function(user) {
                if (user) {
                    userObj = user;
                    myReftoDisconnect = dB.ref("/users/"+userObj.uid+"/iconnect");
                    myReftoDisconnect.set(true);
                    myReftoDisconnect.onDisconnect().set("disconnected");
                    userLoggedIn=true;//used below to state user is logged in and to proceed to next page

                    var name = databaseObj.users[userObj.uid].name;
                    var email = databaseObj.users[userObj.uid].email;
                    var phoneNumber = databaseObj.users[userObj.uid].phoneNumber;
                    if(databaseObj.users[userObj.uid].address !=undefined){
                        accountInfo = "<ul><li>" + name + "</li><li>" + email + "</li><li>" + phoneNumber + "</li><li>"+databaseObj.users[userObj.uid].address+"</li><li id='signOut'>Sign Out</li></ul>";//provides welcome greeting
                    } else {//don't include address yet, this will be included when the user provides address
                        accountInfo = "<ul><li>" + name + "</li><li>" + email + "</li><li>" + phoneNumber + "</li><li id='signOut'>Sign Out</li></ul>";//provides welcome greeting
                    }
                    requestFunctions();
                    $("#userInfo").html(accountInfo);
                    if(databaseObj!=null&&databaseObj!=undefined&&address!=undefined&&gpsProcessed==false&&databaseObj.users[userObj.uid].serving==undefined){
                        gpsProcessor();//dealing with two asynchronous and separately fired functions and want this to run only when all of this information is available (database and address each being generated from two different functions) and for it to run only once - so I check that all data has been set and then I put in a boolean processed to allow me to control how many times this runs
                    }

                } else {
                    userLoggedIn=false;//used below to state user is not logged in and to prompt user with a modal
                }
            });
        });

        //////////////////////MODAL CSS - CHANGE COLOR OF BACKGROUND DEPENDING ON WHICH MODAL IS SHOWN

        //I want different colored backdrops for the modals depending on the modal
        $("#requestModal").on("show.bs.modal", function() {
            setTimeout(function(){        
                $(".modal-backdrop").css("background", "#003600");//change color of modal-backdrop
                $(".modal-backdrop").css("opacity","1");
            },10);
        });

        // Triggers as soon as 'requestModal' is closed
        $('#requestModal').on('hidden.bs.modal', function() {
          $('.modal-backdrop').css("background", "");//change color of modal-backdrop
            $(".modal-backdrop").css("opacity","0");
        });

        // Triggers as soon as 'gpsModal' Opens
        $('#gpsModal').on('show.bs.modal', function() {
            setTimeout(function(){
                $('.modal-backdrop').css("background", "#404040");//change color of modal-backdrop
                $(".modal-backdrop").css("opacity",".7");
            },10);
        });

        // Triggers as soon as 'gpsModal' is closed
        $('#gpsModal').on('hidden.bs.modal', function() {
          $('.modal-backdrop').css("background", "");//change color of modal-backdrop
          $(".modal-backdrop").css("opacity","0");
        });


        var gpsProcessed=false;
        function gpsProcessor(){
            gpsProcessed=true;
            if(databaseObj.users[userObj.uid].cameFromOtherPage == false){//will run when the user came from the other page because cameFromOtherPage will be false - address just set by user on the other page, so asking for address again is not necessary
                if(address != databaseObj.users[userObj.uid].address || databaseObj.users[userObj.uid].address == undefined){                          
                    if(address!=undefined){//want to continually run this query to see when address is set - when this becomes false, when address is set, then we want to quit this interval and show the modal that asks about current address
                        if(acceptPushed==false&&submitPushed==false){
                            if(modalShown==false){
                                $("#gpsModal").modal({backdrop: 'static', keyboard: false});
                                $("#gpsModal").modal("show");                                
                                $("#address").html("We have calculated your address to be:<br><span id='returnedAddress'>"+address+"</span><br>Is this correct?");
                                $("#accept").css("display","block");
                                $("#reject").css("display","block");
                                modalShown = true;
                            }
                        }
                    }
                } else {//will run when the address generated by the navigator.geolocation matches what is in the database
                    if(acceptPushed==false&&submitPushed==false){
                    //when either the accept button is pushed or the submit button is pushed, we push new information to firebase under certain circumstances, and then we call google maps functions to perform map operations. if we don't have this condition, the operations will be performed twice when those buttons are pushed because this code will be executed on the firebase onvalue change trigger
                        if(mapSet==false){
                            loc_GoogMaps = new google.maps.LatLng(databaseObj.users[userObj.uid].coords.lat, databaseObj.users[userObj.uid].coords.long);
                            moveToLocation();
                        }
                    }
                }
            } else {//will run when the user came from the other page because cameFromOtherPage will be false - address just set by user on the other page, so asking for address again is not necessary
                if(mapSet==false){
                    loc_GoogMaps = new google.maps.LatLng(databaseObj.users[userObj.uid].coords.lat, databaseObj.users[userObj.uid].coords.long);
                    moveToLocation();
                }
            }
        }

        var lat,long,address,streetAddress,city,state,zip,country,success,geocoder;
        var loc_GoogMaps,acceptPushed = false,submitPushed = false;
        $("#accept").on("click",function(){//accept the geolocation calculated by browser
            acceptPushed=true;
            $("#address").css("display","none");
            $("#accept").css("display","none");
            $("#reject").css("display","none");
            $("#reject").css("display","none");
            $("#reject").css("display","none");
            $("#gps-body").append("Thank you. Click button to continue.");
            $("#Proceed").css("display","block");
            loc_GoogMaps = new google.maps.LatLng(lat, long);
            moveToLocation();
            if(databaseObj.users[userObj.uid].address!=address){
                dB.ref("/users/"+userObj.uid+"/coords").set({"lat":lat,"long":long});
                dB.ref("/users/"+userObj.uid+"/address").set(address);
            }            
        })

        $("#reject").on("click",function(){
            $("#address").css("display","none");
            $("#accept").css("display","none");
            $("#reject").css("display","none");
            $("#correctAddress").css("display","block");
            $("#submit").css("display","block");
            $("#instruct").css("display","block");
            if(databaseObj.users[userObj.uid].address!=undefined){
                $("#correctAddress").val(databaseObj.users[userObj.uid].address);
            }
        })

        $("#submit").on("click",function(){
            submitPushed=true;

            $("#instruct").css("display","none");
            $("#address").css("display","none");
            $("#accept").css("display","none");
            $("#reject").css("display","none");
            $("#correctAddress").css("display","none");
            $("#submit").css("display","none");
            $("#gps-body").append("Thank you. Click button to continue.");
            $("#Proceed").css("display","block");

            var correctAddress = $("#correctAddress").val();
                        
            geocoder = new google.maps.Geocoder;
            geocoder.geocode({"address":correctAddress},function(results,status){
                if(status==="OK"){
                    loc_GoogMaps = results[0].geometry.location;
                    lat=results[0].geometry.location.lat();
                    long=results[0].geometry.location.lng();
                    dB.ref("/users/"+userObj.uid+"/coords").set({"lat":lat,"long":long});
                    dB.ref("/users/"+userObj.uid+"/address").set(correctAddress);
                    moveToLocation();
                }

            })

        })

        //series of functions to check different nodes of users

        var helperOpsRan=false,requesterStatusOpsRan=false,requesterAlert;
        
        function requestFunctions(){//checking actions of other user
            //order of things matter here. knowing that 
            dB.ref("/users/"+userObj.uid+"/serving").on("value",function(snapshot){
                console.log(snapshot.val());
                if(snapshot.val()!=null && helperOpsRan==false){//adds an actions button that will serve as operations for the user to manage their request            
                    helperOpsRan = true;
                    var requester = snapshot.val();
                    requesterUID = requester.requesterUID;
                    var requesterName = databaseObj.users[requesterUID].name;
                    var request = databaseObj.users[requesterUID].helpRequest;
                    var requesterPhone = databaseObj.users[requesterUID].phoneNumber;
                    var requesterEmail = databaseObj.users[requesterUID].email;
                    $("div#userInfo_Rmodal").html(accountInfo.replace("signOut","RsignOut"));
                    $("#pendingRequest").empty();
                    var offerMsg = $("<p id='offerMsg'> You have offered to help " + requesterName + " with \"" + request + ".\"</p>");
                    $("#pendingRequest").append(offerMsg);
                    var menuBtn = $("<button class='btn btn-default btn-block' id='actions'>Actions for request: \"" + request + "\"<i class='fa fa-fw'></i><i class='fa fa-plus-circle'></i></button>");
                    $("#pendingRequest").append(menuBtn);
                    var DrpBtn1 = $("<button class='collapsed btn btn-block' id='contact'><i class='fa fa-phone'></i><i class='fa fa-fw'></i>Contact " + requesterName.substr(0,requesterName.indexOf(" ")) + "<i class='fa fa-fw'></i><i class='fa fa-plus-circle'></i></button>");
                    $("#pendingRequest").append(DrpBtn1);
                    var contactDiv = $("<div id='contactDiv'>Here's " + requesterName.substr(0,requesterName.indexOf(" ")) + "'s email and phone number: <p>Email: " + requesterEmail + "</p><p> Phone: " + requesterPhone + "</p><p>Alternatively, you can chat with " + requesterName.substr(0,requesterName.indexOf(" ")) + " using our chat app. Click here to access our chat app.</div>");
                    $("#pendingRequest").append(contactDiv);
                    var DrpBtn2 = $("<button class='collapsed btn btn-block' id='complete'><i class='fa fa-check-square-o'></i><i class='fa fa-fw'></i>Mark Complete</button>");
                    $("#pendingRequest").append(DrpBtn2);
                    var showMap = $("<button class='btn btn-default' id='navigation' state='hidden'><i class='fa fa-compass' aria-hidden='true'></i><i class='fa fa-fw'></i>Navigation</buttons>");
                    $("#pendingRequest").append(showMap);
                    var navDiv = $("<div id='navDiv'></div>");
                    var mapDiv = $("<div id='mapDiv'></div>");
                    var routeDiv = $("<div id='routeDiv'></div>");
                    $(navDiv).append(mapDiv);
                    $(navDiv).append(routeDiv);
                    $("#pendingRequest").append(navDiv);
                    $("#requestModal").modal({backdrop: 'static', keyboard: false});
                    $("#requestModal").modal("show");
                }
            })

            dB.ref("/users/"+userObj.uid+"/serving/requesterStatus").on("value",function(snapshot){
                if(snapshot.val()=="complete" && requesterStatusOpsRan==false){
                    requesterStatusOpsRan=true;
                    var requesterName = databaseObj.users[requesterUID].name;
                    var firstName = requesterName.substr(0,requesterName.indexOf(" "));
                    requesterAlert = "<p>Hey, "+firstName+" has marked this request as complete, and has closed this request. Mark this request as complete to submit another request.</p>";
                    $("#helper").prepend(requesterAlert);
                    $("#navigation").prop( "disabled", true );
                    $("#navDiv").css("display","none");
                    $("#contact").prop( "disabled", true );
                    $("#contactDiv").css("display","none");
                }
            })

        }

        $(document).on("click","#navigation",function(){
            if($(this).attr("state","hidden")){

                $("#navDiv").css("display","block");
                $("#mapDiv").css("height","300px");
                setTimeout(function(){
                    startLoc = databaseObj.users[userObj.uid].address;
                    endLoc = databaseObj.users[requesterUID].address;
                    initNavMap(startLoc,userObj.uid,endLoc,requesterUID);
                },500);

            } else if($(this).attr("state","shown")){
            
                $("#mapDiv").empty();
                $("#routeDiv").empty();
                $("#navDiv").css("display","none");
            
            }
        });

        //for actions button animation
        $(document).on("click","#actions",function(){//adding animations for clicking actions button on requestModal
            if($(".collapsed").hasClass("animation-show")){//if animation-show class is present, then action buttons are shown. we want to collapse them so we swap animation-show for animation-hide, change font awesome icon and after animation complete, make display for action buttons "none"
            $(".collapsed").removeClass("animation-show").addClass("animation-hide");
            $("#actions").find(".fa-minus-circle").removeClass("fa-minus-circle").addClass("fa-plus-circle");
            $("#contactDiv").css("display","none");
            $("#contactDiv").removeClass("contact-animation-show").addClass("contact-animation-hide");
            setTimeout(function(){$(".collapsed").css("display","none")},100);
          } else if($(".collapsed").hasClass("animation-hide")){//if animation-hide class is present, then action buttons are collapsed. we want to show them so we swap animation-hide for animation-show, change font awesome icon and make display for action buttons "block" so that animation can be seen
            $("#actions").find(".fa-plus-circle").removeClass("fa-plus-circle").addClass("fa-minus-circle");
            $(".collapsed").removeClass("animation-hide").addClass("animation-show");
            $(".collapsed").css("display","block");
          } else {//animation-show and animation-hide are classes specifically for animation, so they are not part of the action buttons at first. this way the buttons can stay collapsed. so if neither class is present, this means that the buttons are collapsed and need to be shown. so if the action menu button is clicked, we want to add the animation class animation-show to the collapse action buttons to show the buttons, swap the font awesome icon and make the display be block so that the animation can be seen
            $(".collapsed").addClass("animation-show");
            $("#actions").find(".fa-plus-circle").removeClass("fa-plus-circle").addClass("fa-minus-circle");
            $(".collapsed").css("display","block");
          }
        })

        $(document).on("click","#contact",function(){//adding animations for clicking actions button on requestModal
            if($("#contactDiv").hasClass("contact-animation-show")){//if animation-show class is present, then action buttons are shown. we want to collapse them so we swap animation-show for animation-hide, change font awesome icon and after animation complete, make display for action buttons "none"
            $("#contactDiv").removeClass("contact-animation-show").addClass("contact-animation-hide");
            $("#contact").find(".fa-minus-circle").removeClass("fa-minus-circle").addClass("fa-plus-circle");
            setTimeout(function(){$("#contactDiv").css("display","none")},100);
          } else if($("#contactDiv").hasClass("contact-animation-hide")){//if animation-hide class is present, then action buttons are collapsed. we want to show them so we swap animation-hide for animation-show, change font awesome icon and make display for action buttons "block" so that animation can be seen
            $("#contact").find(".fa-plus-circle").removeClass("fa-plus-circle").addClass("fa-minus-circle");
            $("#contactDiv").removeClass("contact-animation-hide").addClass("contact-animation-show");
            $("#contactDiv").css("display","block");
          } else {//animation-show and animation-hide are classes specifically for animation, so they are not part of the action buttons at first. this way the buttons can stay collapsed. so if neither class is present, this means that the buttons are collapsed and need to be shown. so if the action menu button is clicked, we want to add the animation class animation-show to the collapse action buttons to show the buttons, swap the font awesome icon and make the display be block so that the animation can be seen
            $("#contactDiv").addClass("contact-animation-show");
            $("#contact").find(".fa-plus-circle").removeClass("fa-plus-circle").addClass("fa-minus-circle");
            $("#contactDiv").css("display","block");
          }
        })

        $(document).on("click","#complete",function(){//when helper pushes complete button
            dB.ref("/users/"+userObj.uid+"/serving").remove();//remove helper info from node

            if(databaseObj.users[requesterUID].helpedBy!=null){
                if(databaseObj.users[requesterUID].helpedBy.requesterUID==userObj.uid){
                    dB.ref("/users/"+requesterUID+"/serving/requesterStatus").set("complete");//notify helper that you have marked the request as complete
                }
            }
            
            /*$('#requestModal').modal("hide");*/
            $('#requestModal').fadeOut(1000);
            setTimeout(function(){
                statusOpsRan=false;
                helperOpsRan=false;
                helperStatusOpsRan=false;
            },1000);
        })


        var navMap; 

        function initNavMap(startLoc,helperUID,endLoc,requesterUID){
            var directionsService = new google.maps.DirectionsService;
            var directionsDisplay = new google.maps.DirectionsRenderer;
            var center_lat = databaseObj.users[userObj.uid].coords.lat;
            var center_lng = databaseObj.users[userObj.uid].coords.long;
            var center = {lat:center_lat,lng:center_lng};
            navMap=new google.maps.Map(document.getElementById('mapDiv'),{
                zoom:15,
                center:center
            });
            directionsDisplay.setMap(navMap);

            directionsService.route({
                origin: startLoc,
                destination: endLoc,
                travelMode: "DRIVING"
            }, function(response,status){
                if(status=="OK"){
                    console.log(response);
                    directionsDisplay.setDirections(response);
                    createTable(response.routes[0].legs[0]);
                } else {
                    window.alert("Directions request failed due to " + status);
                }
            });

            google.maps.event.addListener( navMap, 'bounds_changed', onBoundsChanged );
            google.maps.event.addDomListener(navMap, 'resize', function() {
                map.setCenter(center);
            });

        }

        function onBoundsChanged(){
            if ( $(navMap.getDiv()).children().eq(0).height() == window.innerHeight &&
                 $(navMap.getDiv()).children().eq(0).width()  == window.innerWidth ) {
                $("#requestModal").modal("hide");
            }
            else {
                $("#requestModal").modal("show");
            }
        }

        function createTable(directionsArray){
            var requesterName = databaseObj.users[requesterUID].name;
            var firstName = requesterName.substr(0,requesterName.indexOf(" "));
            $("#routeDiv").append("<p>Start Address (Point A - Where you are): " + directionsArray.start_address + "</p><p>End Address (Point B - Where "+firstName+" is): " + directionsArray.end_address + "</p><p>Distance from Point A to Point B: " + directionsArray.distance.text + "</p><p>Duration: " + directionsArray.duration.text + "</p>Driving Directions below:");
            var bigTableText;
            bigTableText = "<table style='width:100%'><tr><th>Instructions</th><th>Duration</th><th>Distance</th></tr>"
            for (var i=0; i<directionsArray.steps.length; i++){
                var instructions=directionsArray.steps[i].instructions;
                var duration=directionsArray.steps[i].duration.text;
                var distance=directionsArray.steps[i].distance.text;
                bigTableText=bigTableText+ "<tr><td>"+instructions+"</td><td>"+duration+"</td><td>"+distance+"</td></tr>";
            }
            bigTableText+="</table>";
            $("#routeDiv").append(bigTableText);
        }

        var map;
        function initMap(){
            var center={lat:32.7767,lng:-96.7970};
            map = new google.maps.Map(document.getElementById('map'),{
                zoom:15,
                center:center,
                fullscreenControl:true
            });

        //////////////////////////////html5 geolocation api mixed with Goog Maps API Geocoding///////////////////////////////

            var options = {
              enableHighAccuracy: true,//set it to this so that we can access the most accurate gps system available on user's system
              timeout: 5000,
              maximumAge: 0
            };

            //if the getCurrentPosition function was able to get your gps location, then we want to do the following function, including running google maps geocode api

            
            function success(pos) {

                var crd = pos.coords;
                lat = crd.latitude;
                long = crd.longitude;

                /////GOOGLE MAPS GEOCODE API FUNCTIONS - gets address
                geocoder = new google.maps.Geocoder;
                var geopos = {lat:lat,lng:long};
                geocoder.geocode({"location":geopos},function(results,status){
                    if(status==="OK"){
                        if(results[0]){
                            address = results[0].formatted_address;//formatted address with street address
                            if(databaseObj!=null&&databaseObj!=undefined&&address!=undefined&&gpsProcessed==false&& databaseObj.users[userObj.uid].serving==undefined){
                                gpsProcessor()
                            }                            
                        }
                    }
                })

            };

            function error(err) {
              console.warn(`ERROR(${err.code}): ${err.message}`);
            };

            //geolocation.getCurrentPosition takes three parameters, 
            //success - function - what do you want to do with the information returned if the function getCurrentPosition runs successfully
            //error - function - how to handle errors
            //options - object - optional parameters for how to handle getting coordinates
            navigator.geolocation.getCurrentPosition(success, error, options);

        }

        var mapSet = false;
        var helperMarker;
        function moveToLocation(){//sets location to show user's current location and sets green helper marker with an infowindow that opens when clicked. also stores marker in markers array
            mapSet = true;
            // using global variable:
            map.panTo(loc_GoogMaps);
            //helper marker
            helperMarker = new google.maps.Marker({
              position: loc_GoogMaps,
              map: map,
              animation: google.maps.Animation.DROP,
              icon: 'http://maps.google.com/mapfiles/ms/icons/green-dot.png'
            });
            var infowindow = new google.maps.InfoWindow({
              content: "You are here"
            });
            helperMarker.addListener('click', function() {
              infowindow.open(map, helperMarker);
            });
            //helpRequest markers
            addRequestMarkersWithinRadius();//now set help request markers
        }


        function addRequestMarkersWithinRadius(){//help request markers
            var bounds = new google.maps.LatLngBounds();
            var markers = [];
            var content;//content for each infowindow attached to a marker

            if(databaseObj.helpRequests!=null&&databaseObj.helpRequests!=undefined){

                for (var i=0; i<Object.keys(databaseObj.helpRequests).length;i++){
                    var helpuid = Object.keys(databaseObj.helpRequests)[i];

                    if(helpuid!=userObj.uid && databaseObj.helpRequests[helpuid]=="open"){
                        
                        var helpAddress=databaseObj.users[helpuid].address;
                        var lat_help = databaseObj.users[helpuid].coords.lat;
                        var long_help = databaseObj.users[helpuid].coords.long;
                        var loc_GoogMaps_help = new google.maps.LatLng(lat_help, long_help);  
                        
                        var marker = new google.maps.Marker({
                          position: loc_GoogMaps_help,
                          map: map,
                          animation: google.maps.Animation.DROP
                        });

                        markers.push(marker);

                        bounds.extend(helperMarker.getPosition());

                        for (var j = 0; j < markers.length; j++) {
                            bounds.extend(markers[j].getPosition());
                        }

                        content = "<div><p id='request'>"+databaseObj.users[helpuid].helpRequest+"</p><p id='help_name'>"+databaseObj.users[helpuid].name + "</p><p id='help_address'>" + databaseObj.users[helpuid].address + "</p><button class='contact' uid="+helpuid+">Help!</button></div>";

                        attachListener(marker,content);
                    
                    }

                }

                map.fitBounds(bounds);
            }

                
        }

        function attachListener(marker,content){//for setting info window data to each help marker
            var infowindow = new google.maps.InfoWindow({
                content:content
            });

            marker.addListener("click",function(){
                infowindow.open(marker.get("map"),marker);
            });
        }

        var requesterUID,statusOfRequest; //store UID of requester
        $(document).on("click",".contact",function(){
            requesterUID = $(this).attr("uid");
            statusofRequest = databaseObj.helpRequests[requesterUID];
            var name = databaseObj.users[requesterUID].name;
            if(statusofRequest=="open"){        
                $("#confirmModal").modal("show");
                $(".confirmMessage").html("<p id='confirm-message'>Help " + $(this).parent().find("#help_name").html() + " with \"" + $(this).parent().find("#request").html()+"\"?</p><button id='confirmBtn' class='btn btn-primary btn-block' data-dismiss='modal' aria-hidden='true'>Continue</button>");
            } else {
                $("#confirmModal").modal("show");
                $(".confirmMessage").html("<p id='confirm-message'>Either someone else has recently accepted "+requesterName.substr(0,requesterName.indexOf(" "))+"'s request or "+requesterName.substr(0,requesterName.indexOf(" "))+" has withdrawn his request for help. The map is being updated now. Click outside this box to find another person in need of help.</p>");
                initMap();
                moveToLocation();
            }
        })

        /////////////////////////////////////////////////////////////////////////////////////////////////////////
        //go to other pages

        //go to Get Help page
        $("#disclaimer>a").on("click",function(){
           gotoGetHelp();
        })

        $("p#getHelp").on("click",function(){
           gotoGetHelp();
        })

        function gotoGetHelp(){
            dB.ref("/users/" + userObj.uid + "/cameFromOtherPage").set(true);
            var win = window.open("help_page.html","_self");
            win.focus();
        }

        //sign out and go to home page
        $(document).on("click","#signOut",function(){
            firebase.auth().signOut().then(function() {
                var win = window.open("index.html","_self");
                win.focus();     
            }, function(error) {
                console.error('Sign Out Error', error);
            });
        })

        //sign out and go to home page
        $(document).on("click","#RsignOut",function(){
            firebase.auth().signOut().then(function() {
                var win = window.open("index.html","_self");
                win.focus();     
            }, function(error) {
                console.error('Sign Out Error', error);
            });
        })

        $(document).on("click","#confirmBtn",function(){
            dB.ref("/helpRequests/"+requesterUID).set("beingHelped");
            dB.ref("/users/"+requesterUID+"/helpedBy").set({
                helperUID:userObj.uid,
                helperStatus:"live"
            });
            dB.ref("/users/"+userObj.uid+"/serving").set({
                requesterStatus:"live",
                description:databaseObj.users[requesterUID].helpRequest,
                requesterUID:requesterUID
            });
            initMap();
            moveToLocation();
        })

    </script>
    <script async defer
    src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCJRXIv3oHTTTjcAfMJuM-kILQXbkYJNCk&libraries=geometry&callback=initMap">
    </script>   

</body>

</html>